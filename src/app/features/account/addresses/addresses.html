<div class="section-header">
    <h2>My Addresses</h2>
    <div class="header-actions">
        <button type="button" class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#addressModal"
            (click)="openAddModal()">
            <i class="bi bi-plus-lg me-2"></i>
            Add New Address
        </button>
    </div>
</div>

<div class="addresses-grid">
    @if (isLoading) {
    <!-- Loading Skeleton -->
    @for (item of [1,2,3]; track item) {
    <div class="address-card skeleton-card">
        <div class="skeleton-header"></div>
        <div class="skeleton-content"></div>
    </div>
    }
    } @else {
    @for (address of addresses; track address.id) {
    <div class="address-card" [class.default]="address.isDefault">
        <div class="card-header">
            <h4>{{ address.label }}</h4>
            @if (address.isDefault) {
            <span class="default-badge">Default</span>
            }
        </div>
        <div class="card-body">
            <p class="address-text">
                {{ address.street }}, {{ address.building }}<br>
                @if (address.district) { {{ address.district }}<br> }
                {{ address.city }}, {{ address.governorate }}<br>
                {{ address.country }}
            </p>
            <div class="contact-info">
                <div><i class="bi bi-person"></i> {{ address.fullName }}</div>
                <div><i class="bi bi-telephone"></i> +20 {{ address.mobileNumber }}</div>
            </div>
        </div>
        <div class="card-actions">
            <button type="button" class="btn-edit" data-bs-toggle="modal" data-bs-target="#addressModal"
                (click)="openEditModal(address)">
                <i class="bi bi-pencil"></i>
                Edit
            </button>
            <button type="button" class="btn-remove" (click)="removeAddress(address.id)">
                <i class="bi bi-trash"></i>
                Remove
            </button>
            @if (!address.isDefault) {
            <button type="button" class="btn-make-default" (click)="makeDefault(address.id)">Make Default</button>
            }
        </div>
    </div>
    }
    @if (addresses.length === 0) {
    <div class="no-addresses" style="grid-column: 1/-1; text-align: center; padding: 2rem;">
        <i class="bi bi-geo-alt" style="font-size: 3rem; color: #ccc;"></i>
        <p style="margin-top: 1rem; color: #666;">No addresses found.</p>
    </div>
    }
    }
</div>

<!-- Address Modal -->
<div class="modal fade" id="addressModal" tabindex="-1" aria-labelledby="addressModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addressModalLabel">
                    <i class="bi bi-geo-alt me-2"></i>
                    {{ modalTitle }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form #addressForm="ngForm" class="address-form needs-validation" novalidate>
                    <div class="form-group mb-3">
                        <label for="modalAddressLabel" class="form-label">Address Label (optional)</label>
                        <input type="text" class="form-control" id="modalAddressLabel" name="label"
                            [(ngModel)]="newAddress.label" placeholder="e.g., Home, Office, etc." maxlength="50">
                    </div>

                    <div class="row">
                        <div class="col-md-6 form-group mb-3">
                            <label for="modalFullName" class="form-label">Full Name *</label>
                            <input type="text" class="form-control" id="modalFullName" name="fullName"
                                [(ngModel)]="newAddress.fullName" placeholder="Your full name" required maxlength="50"
                                #fullName="ngModel" [class.is-invalid]="fullName.invalid && fullName.touched">
                            <div class="invalid-feedback">Full name is required.</div>
                        </div>
                        <div class="col-md-6 form-group mb-3">
                            <label for="modalPhoneNumber" class="form-label">Phone Number *</label>
                            <div class="phone-input-group"
                                [class.border-danger]="mobileNumber.invalid && mobileNumber.touched">
                                <div class="country-code-display">
                                    <img src="https://flagcdn.com/w20/eg.png" alt="EG" class="country-flag" />
                                    <span>+20</span>
                                </div>
                                <input type="tel" class="phone-number-input form-control" id="modalPhoneNumber"
                                    name="mobileNumber" [(ngModel)]="newAddress.mobileNumber" placeholder="1012 345 678"
                                    required maxlength="10" #mobileNumber="ngModel">
                            </div>
                            <div class="invalid-feedback"
                                [style.display]="mobileNumber.invalid && mobileNumber.touched ? 'block' : 'none'">
                                Phone number is required.
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-8 form-group mb-3">
                            <label for="modalStreetAddress" class="form-label">Street Address *</label>
                            <input type="text" class="form-control" id="modalStreetAddress" name="street"
                                [(ngModel)]="newAddress.street" placeholder="Street name and number" required
                                maxlength="60" #street="ngModel" [class.is-invalid]="street.invalid && street.touched">
                            <div class="invalid-feedback">Street address is required.</div>
                        </div>
                        <div class="col-md-4 form-group mb-3">
                            <label for="modalBuilding" class="form-label">Building/Apt *</label>
                            <input type="text" class="form-control" id="modalBuilding" name="building"
                                [(ngModel)]="newAddress.building" placeholder="Bldg, Apt, etc." required maxlength="50"
                                #building="ngModel" [class.is-invalid]="building.invalid && building.touched">
                            <div class="invalid-feedback">Building/Apt is required.</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 form-group mb-3">
                            <label for="modalDistrict" class="form-label">District (optional)</label>
                            <input type="text" class="form-control" id="modalDistrict" name="district"
                                [(ngModel)]="newAddress.district" placeholder="District" maxlength="50">
                        </div>
                        <div class="col-md-4 form-group mb-3">
                            <label for="modalCity" class="form-label">City *</label>
                            <div class="position-relative">
                                <input type="text" class="form-control" id="modalCity" name="city"
                                    [(ngModel)]="newAddress.city" placeholder="City" required #city="ngModel"
                                    autocomplete="nope" (input)="onCityInput()" (focus)="onCityInput()"
                                    (blur)="hideCitySuggestions()" (keydown)="onCityKeyDown($event)"
                                    [class.is-invalid]="city.invalid && city.touched">
                                @if (showCitySuggestions) {
                                <ul class="city-suggestions-dropdown">
                                    @for (suggestion of filteredCities; track suggestion; let i = $index) {
                                    <li (mousedown)="selectCity(suggestion)" class="city-suggestion-item"
                                        [class.active]="i === highlightedIndex">
                                        {{ suggestion }}
                                    </li>
                                    }
                                </ul>
                                }
                            </div>
                            <div class="invalid-feedback"
                                [style.display]="(city.invalid || cityInvalid) && city.touched ? 'block' : 'none'">
                                @if (cityInvalid) {
                                Please select a valid city from the list.
                                } @else {
                                City is required.
                                }
                            </div>
                        </div>
                        <div class="col-md-4 form-group mb-3">
                            <label for="modalGovernorate" class="form-label">Governorate (optional)</label>
                            <input type="text" class="form-control" id="modalGovernorate" name="governorate"
                                [(ngModel)]="newAddress.governorate" placeholder="Governorate" maxlength="50">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 form-group mb-3">
                            <label for="modalZipCode" class="form-label">Zip Code (optional)</label>
                            <input type="text" class="form-control" id="modalZipCode" name="zipCode"
                                [(ngModel)]="newAddress.zipCode" placeholder="12345" maxlength="50">
                        </div>
                        <div class="col-md-6 form-group mb-3">
                            <label for="modalCountry" class="form-label">Country *</label>
                            <div class="position-relative">
                                <input type="text" class="form-control" id="modalCountry" name="country"
                                    [(ngModel)]="newAddress.country" placeholder="Country" required #country="ngModel"
                                    autocomplete="nope" (input)="onCountryInput()" (focus)="onCountryInput()"
                                    (blur)="hideCountrySuggestions()" (keydown)="onCountryKeyDown($event)"
                                    [class.is-invalid]="country.invalid && country.touched">
                                @if (showCountrySuggestions) {
                                <ul class="country-suggestions-dropdown city-suggestions-dropdown">
                                    @for (suggestion of filteredCountries; track suggestion; let i = $index) {
                                    <li (mousedown)="selectCountry(suggestion)" class="city-suggestion-item"
                                        [class.active]="i === countryHighlightedIndex">
                                        {{ suggestion }}
                                    </li>
                                    }
                                </ul>
                                }
                            </div>
                            <div class="invalid-feedback"
                                [style.display]="(country.invalid || countryInvalid) && country.touched ? 'block' : 'none'">
                                @if (countryInvalid) {
                                Please select a supported country from the list.
                                } @else {
                                Country is required.
                                }
                            </div>
                        </div>
                    </div>

                    <div class="form-group mb-3">
                        <label for="modalHints" class="form-label">Nearest Landmark / Hints (optional)</label>
                        <textarea class="form-control" id="modalHints" name="hints" rows="1"
                            [(ngModel)]="newAddress.hints" placeholder="Near to..." maxlength="100"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" (click)="saveNewAddress(addressForm)">
                    <i class="bi bi-check-lg me-1"></i>
                    Save Address
                </button>
            </div>
        </div>
    </div>
</div>