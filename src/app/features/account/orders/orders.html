<div class="section-header">
    <h2>My Orders</h2>
    <div class="header-actions">
        <div class="dropdown">
            <button class="filter-btn" data-bs-toggle="dropdown">
                <i class="bi bi-sort-down"></i>
                <span>{{ currentSort || 'Sort By' }}</span>
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="javascript:void(0)" (click)="setSort('Date: Newest First')">Date:
                        Newest First</a></li>
                <li><a class="dropdown-item" href="javascript:void(0)" (click)="setSort('Date: Oldest First')">Date:
                        Oldest First</a></li>
                <li>
                    <hr class="dropdown-divider">
                </li>
                <li><a class="dropdown-item" href="javascript:void(0)"
                        (click)="setSort('Order Total: Low to High')">Order Total: Low to High</a></li>
                <li><a class="dropdown-item" href="javascript:void(0)"
                        (click)="setSort('Order Total: High to Low')">Order Total: High to Low</a></li>
            </ul>
        </div>
        <div class="dropdown">
            <button class="filter-btn" data-bs-toggle="dropdown">
                <i class="bi bi-funnel"></i>
                <span>{{ currentFilter || 'Filter By' }}</span>
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="javascript:void(0)" (click)="setFilter('All Orders')">All Orders</a>
                </li>
                <li><a class="dropdown-item" href="javascript:void(0)" (click)="setFilter('Pending')">Pending</a>
                </li>
                <li><a class="dropdown-item" href="javascript:void(0)" (click)="setFilter('Processing')">Processing</a>
                </li>
                <li><a class="dropdown-item" href="javascript:void(0)" (click)="setFilter('Shipped')">Shipped</a></li>
                <li><a class="dropdown-item" href="javascript:void(0)" (click)="setFilter('Delivered')">Delivered</a>
                </li>
                <li><a class="dropdown-item" href="javascript:void(0)" (click)="setFilter('Cancelled')">Cancelled</a>
                </li>
            </ul>
        </div>
    </div>
</div>

<div class="orders-grid">
    @if (isLoading) {
    <!-- Loading Skeleton -->
    @for (item of [1,2,3]; track item) {
    <div class="order-card skeleton-card">
        <div class="skeleton-header"></div>
        <div class="skeleton-content"></div>
    </div>
    }
    } @else {
    @for (order of orders; track order.id) {
    <!-- Order Card -->
    <div class="order-card">
        <div class="order-header">
            <div class="order-id">
                <span class="label">Order ID:</span>
                <span class="value">#{{ order.id }}</span>
            </div>
            <div class="order-date">{{ order.created | date:'MMM d, y' }}</div>
        </div>
        <div class="order-content">
            <div class="product-grid">
                @if (order.items.length > visibleItemsLimit + 1) {
                @for (item of order.items.slice(0, visibleItemsLimit); track item.productId) {
                <img [src]="item.productThumbnailUrl" [alt]="item.productName" loading="lazy">
                }
                <div class="more-items-placeholder">
                    +{{ order.items.length - visibleItemsLimit }}
                </div>
                } @else {
                @for (item of order.items; track item.productId) {
                <img [src]="item.productThumbnailUrl" [alt]="item.productName" loading="lazy">
                }
                }
            </div>
            <div class="order-info">
                <div class="info-row">
                    <span>Status</span>
                    <span class="status" [ngClass]="order.status.toLowerCase()">{{ order.status }}</span>
                </div>
                <div class="info-row">
                    <span>Items</span>
                    <span>{{ order.itemsCount }} items</span>
                </div>
                <div class="info-row">
                    <span>Total</span>
                    <span class="price">{{ order.totalAmount | number:'1.2-2' }} <span
                            class="currency-suffix">EGP</span></span>
                </div>
            </div>
        </div>
        <div class="order-footer">
            @if (order.status.toLowerCase() !== 'cancelled') {
            <button type="button" class="btn-track" data-bs-toggle="collapse"
                [attr.data-bs-target]="'#tracking' + order.id" aria-expanded="false">Track Order</button>
            } @else {
            <button type="button" class="btn-reorder" (click)="reOrder(order)">
                <i class="bi bi-arrow-repeat me-1"></i> Re-order
            </button>
            }
            <button type="button" class="btn-details" data-bs-toggle="collapse"
                [attr.data-bs-target]="'#details' + order.id" aria-expanded="false">View Details</button>
        </div>

        <!-- Order Tracking -->
        <div class="collapse tracking-info" [id]="'tracking' + order.id">
            <div class="tracking-timeline">
                <!-- Pending -->
                <div class="timeline-item" [ngClass]="getTimelineItemClass(order, 'pending')">
                    <div class="timeline-icon">
                        <i class="bi"
                            [ngClass]="isMilestoneCompleted(order.orderTrackingMilestones, 'pending') ? 'bi-check-circle-fill' : 'bi-circle'"></i>
                    </div>
                    <div class="timeline-content">
                        <h5>Pending</h5>
                        <p>Your order is received and waiting for payment verification</p>
                        @if (getMilestoneTimestamp(order.orderTrackingMilestones, 'pending')) {
                        <span class="timeline-date">{{ getMilestoneTimestamp(order.orderTrackingMilestones, 'pending') |
                            date:'MMM d, y - h:mm a' }}</span>
                        }
                    </div>
                </div>

                <!-- Processing -->
                <div class="timeline-item" [ngClass]="getTimelineItemClass(order, 'processing')">
                    <div class="timeline-icon">
                        <i class="bi"
                            [ngClass]="isMilestoneCompleted(order.orderTrackingMilestones, 'processing') ? 'bi-check-circle-fill' : 'bi-gear'"></i>
                    </div>
                    <div class="timeline-content">
                        <h5>Processing</h5>
                        <p>Your order is being prepared for shipment</p>
                        @if (getMilestoneTimestamp(order.orderTrackingMilestones, 'processing')) {
                        <span class="timeline-date">{{ getMilestoneTimestamp(order.orderTrackingMilestones,
                            'processing') | date:'MMM d, y - h:mm a' }}</span>
                        }
                    </div>
                </div>

                <!-- Shipped -->
                <div class="timeline-item" [ngClass]="getTimelineItemClass(order, 'shipped')">
                    <div class="timeline-icon">
                        <i class="bi"
                            [ngClass]="isMilestoneCompleted(order.orderTrackingMilestones, 'shipped') ? 'bi-check-circle-fill' : 'bi-box-seam'"></i>
                    </div>
                    <div class="timeline-content">
                        <h5>Shipped</h5>
                        <p>Your order has been shipped</p>
                        @if (getMilestoneTimestamp(order.orderTrackingMilestones, 'shipped')) {
                        <span class="timeline-date">{{ getMilestoneTimestamp(order.orderTrackingMilestones, 'shipped') |
                            date:'MMM d, y - h:mm a' }}</span>
                        }
                    </div>
                </div>

                <!-- Delivered -->
                <div class="timeline-item" [ngClass]="getTimelineItemClass(order, 'delivered')">
                    <div class="timeline-icon">
                        <i class="bi"
                            [ngClass]="isMilestoneCompleted(order.orderTrackingMilestones, 'delivered') ? 'bi-check-circle-fill' : 'bi-truck'"></i>
                    </div>
                    <div class="timeline-content">
                        <h5>Delivered</h5>
                        <p>Your order has been delivered</p>
                        @if (getMilestoneTimestamp(order.orderTrackingMilestones, 'delivered')) {
                        <span class="timeline-date">{{ getMilestoneTimestamp(order.orderTrackingMilestones, 'delivered')
                            | date:'MMM d, y - h:mm a' }}</span>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Details -->
        <div class="collapse order-details" [id]="'details' + order.id">
            <div class="details-content">
                <div class="detail-section">
                    <h5>Order Information</h5>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="label">Payment Method</span>
                            <span class="value">{{ formatPaymentMethod(order.paymentMethod) }}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Shipping Method</span>
                            <span class="value">{{ formatShippingMethod(order.shippingMethod) }}</span>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h5>Items ({{ order.itemsCount }})</h5>
                    <div class="order-items">
                        @for (item of order.items; track item.productId) {
                        <div class="item">
                            <img [src]="item.productThumbnailUrl" [alt]="item.productName" loading="lazy">
                            <div class="item-info">
                                <h6>{{ item.productName }}</h6>
                                <div class="item-meta">
                                    <span class="sku">SKU: #{{ item.productId }}</span>
                                    <span class="qty">Qty: {{ item.quantity }}</span>
                                </div>
                            </div>
                            <div class="item-price">{{ item.total | number:'1.2-2' }} <span
                                    class="currency-suffix">EGP</span></div>
                        </div>
                        }
                    </div>
                </div>

                <div class="detail-section">
                    <h5>Price Details</h5>
                    <div class="price-breakdown">
                        <div class="price-row">
                            <span>Subtotal</span>
                            <span>{{ order.subtotal | number:'1.2-2' }} <span class="currency-suffix">EGP</span></span>
                        </div>
                        <div class="price-row">
                            <span>Shipping</span>
                            <span>{{ order.shippingFees | number:'1.2-2' }} <span
                                    class="currency-suffix">EGP</span></span>
                        </div>
                        <div class="price-row">
                            <span>Tax</span>
                            <span>{{ order.taxes | number:'1.2-2' }} <span class="currency-suffix">EGP</span></span>
                        </div>
                        <div class="price-row total">
                            <span>Total</span>
                            <span>{{ order.totalAmount | number:'1.2-2' }} <span
                                    class="currency-suffix">EGP</span></span>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h5>Shipping Address</h5>
                    <div class="address-info">
                        <div class="address-card-header">
                            <div class="header-left">
                                <i class="bi bi-geo-alt-fill"></i>
                                <span class="address-label">{{ order.shippingAddress.label }}</span>
                            </div>
                        </div>
                        <div class="row">
                            <!-- Contact Details Column -->
                            <div class="col-md-6">
                                <p class="address-name"><i class="bi bi-person-fill"></i> {{
                                    order.shippingAddress.fullName }}</p>
                                <p class="address-phone"><i class="bi bi-telephone-fill"></i><span>+20 {{
                                        order.shippingAddress.mobileNumber }}</span></p>
                            </div>
                            <!-- Address Details Column -->
                            <div class="col-md-6">
                                <div class="address-details">
                                    <p class="address-line">
                                        <i class="bi bi-shop text-secondary me-2"></i>
                                        <span>{{ order.shippingAddress.street }}, {{ order.shippingAddress.building
                                            }}</span>
                                    </p>
                                    <p class="address-line">
                                        <i class="bi bi-geo text-secondary me-2"></i>
                                        <span>{{ order.shippingAddress.district }}</span>
                                    </p>
                                    <p class="address-line">
                                        <i class="bi bi-geo-alt text-secondary me-2"></i>
                                        <span>{{ order.shippingAddress.city }}, {{ order.shippingAddress.governorate
                                            }}</span>
                                    </p>
                                    @if (order.shippingAddress.zipCode) {
                                    <p class="address-line">
                                        <i class="bi bi-mailbox text-secondary me-2"></i>
                                        <span><span class="text-xs text-uppercase fw-bold text-muted me-1">Zip:</span>{{
                                            order.shippingAddress.zipCode }}</span>
                                    </p>
                                    }
                                    <p class="address-line">
                                        <i class="bi bi-globe-americas text-secondary me-2"></i>
                                        <span>{{ order.shippingAddress.country }}</span>
                                    </p>
                                    @if (order.shippingAddress.hints) {
                                    <p class="address-hints mt-2">
                                        <i class="bi bi-info-circle-fill text-accent me-2"></i>
                                        <span>{{ order.shippingAddress.hints }}</span>
                                    </p>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    }
    @if (orders.length === 0) {
    <div class="no-orders" style="grid-column: 1/-1; text-align: center; padding: 2rem;">
        <i class="bi bi-box-seam" style="font-size: 3rem; color: #ccc;"></i>
        <p style="margin-top: 1rem; color: #666;">No orders found.</p>
    </div>
    }
    }
</div>

<!-- Pagination -->
@if (totalPages > 1) {
<div class="pagination-wrapper">
    <button type="button" class="btn-prev" [disabled]="pageIndex === 1" (click)="onPageChange(pageIndex - 1)">
        <i class="bi bi-chevron-left"></i>
    </button>
    <div class="page-numbers">
        @for (page of pages; track page) {
        @if (page === -1) {
        <span>...</span>
        } @else {
        <button type="button" [class.active]="page === pageIndex" (click)="onPageChange(page)">{{ page }}</button>
        }
        }
    </div>
    <button type="button" class="btn-next" [disabled]="pageIndex === totalPages" (click)="onPageChange(pageIndex + 1)">
        <i class="bi bi-chevron-right"></i>
    </button>
</div>
}