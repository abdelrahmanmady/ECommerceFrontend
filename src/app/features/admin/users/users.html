<!-- Users List View -->
<div class="container py-4">
  <!-- Page Header -->
  <div class="page-header">
    <h1><i class="fas fa-users me-3"></i>Users Management</h1>
    <p>Manage users and assign roles</p>
  </div>

  <!-- Scroll Anchor -->
  <div id="usersTableAnchor"></div>

  <!-- Premium Filter Toolbar (Compact Split) -->
  <div class="filter-bar">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
      <!-- Search (Left) -->
      <div class="search-pill" style="min-width: 400px">
        <i class="fas fa-search"></i>
        <input
          type="text"
          class="form-control-plaintext ps-1"
          placeholder="Search users by name, email or phone number"
          (input)="onSearch($any($event.target).value)"
          [value]="searchTerm"
        />
      </div>

      <!-- Filters (Right) -->
      <div class="d-flex align-items-center gap-4">
        <!-- Filter Group -->
        <div class="d-flex gap-2">
          <!-- Role Filter -->
          <div class="dropdown custom-dropdown">
            <button
              class="filter-btn"
              type="button"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              <i class="fas fa-user-tag"></i>
              <span>{{
                !selectedRole || selectedRole === 'all' ? 'All Roles' : (selectedRole | titlecase)
              }}</span>
              <i class="fas fa-chevron-down ms-1"></i>
            </button>
            <ul class="dropdown-menu">
              <li>
                <a
                  class="dropdown-item"
                  [class.active]="selectedRole === 'all' || !selectedRole"
                  (click)="onRoleChange('all')"
                  >All Roles</a
                >
              </li>
              <li>
                <a
                  class="dropdown-item"
                  [class.active]="selectedRole === 'admin'"
                  (click)="onRoleChange('admin')"
                  >Admin</a
                >
              </li>
              <li>
                <a
                  class="dropdown-item"
                  [class.active]="selectedRole === 'seller'"
                  (click)="onRoleChange('seller')"
                  >Seller</a
                >
              </li>
              <li>
                <a
                  class="dropdown-item"
                  [class.active]="selectedRole === 'customer'"
                  (click)="onRoleChange('customer')"
                  >Customer</a
                >
              </li>
            </ul>
          </div>

          <!-- Status Filter -->
          <div class="dropdown custom-dropdown">
            <button
              class="filter-btn"
              type="button"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              <i class="fas fa-info-circle"></i>
              <span>{{
                !selectedStatus || selectedStatus === 'all'
                  ? 'All Users'
                  : (selectedStatus | titlecase)
              }}</span>
              <i class="fas fa-chevron-down ms-1"></i>
            </button>
            <ul class="dropdown-menu">
              <li>
                <a
                  class="dropdown-item"
                  [class.active]="selectedStatus === 'all' || !selectedStatus"
                  (click)="onStatusChange('all')"
                  >All Users</a
                >
              </li>
              <li>
                <a
                  class="dropdown-item"
                  [class.active]="selectedStatus === 'active'"
                  (click)="onStatusChange('active')"
                  >Active</a
                >
              </li>
              <li>
                <a
                  class="dropdown-item"
                  [class.active]="selectedStatus === 'deleted'"
                  (click)="onStatusChange('deleted')"
                  >Deleted</a
                >
              </li>
            </ul>
          </div>
        </div>

        <!-- Sort Dropdown -->
        <div class="dropdown custom-dropdown border-start ps-4">
          <button class="filter-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-sort-amount-down"></i>
            <span>{{ getSortLabel() }}</span>
            <i class="fas fa-chevron-down ms-1"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li>
              <a
                class="dropdown-item"
                [class.active]="selectedSort === 'createdDesc' || !selectedSort"
                (click)="onSortChange('createdDesc')"
                >Newest</a
              >
            </li>
            <li>
              <a
                class="dropdown-item"
                [class.active]="selectedSort === 'createdAsc'"
                (click)="onSortChange('createdAsc')"
                >Oldest</a
              >
            </li>
            <li>
              <a
                class="dropdown-item"
                [class.active]="selectedSort === 'updatedDesc'"
                (click)="onSortChange('updatedDesc')"
                >Last Updated</a
              >
            </li>
            <li>
              <a
                class="dropdown-item"
                [class.active]="selectedSort === 'ordersDesc'"
                (click)="onSortChange('ordersDesc')"
                >Orders Placed</a
              >
            </li>
            <li><hr class="dropdown-divider" /></li>
            <li>
              <a
                class="dropdown-item"
                [class.active]="selectedSort === 'nameAsc'"
                (click)="onSortChange('nameAsc')"
                >Name (A-Z)</a
              >
            </li>
            <li>
              <a
                class="dropdown-item"
                [class.active]="selectedSort === 'emailAsc'"
                (click)="onSortChange('emailAsc')"
                >Email (A-Z)</a
              >
            </li>
          </ul>
        </div>

        <!-- Clear Filters -->
        <button
          class="btn-clear-filters"
          [disabled]="!hasActiveFilters"
          type="button"
          (click)="clearFilters()"
          title="Clear all filters"
        >
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Users Table -->
  <div class="orders-table">
    <!-- Loading Overlay -->
    @if (isLoading()) {
    <div class="loading-overlay">
      <div class="spinner-border text-secondary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
    }

    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th class="ps-4" style="width: 80px">IMAGE</th>
            <th class="text-start ps-3" style="width: 250px">USER</th>
            <th style="width: 15%">PHONE</th>
            <th style="width: 15%">ROLE</th>
            <th style="width: 15%">ORDERS</th>
            <th style="width: 15%">ACTIVITY</th>
            <th>ACTIONS</th>
          </tr>
        </thead>
        <tbody>
          @for (user of users(); track user.id) {
          <tr [class.deleted-row]="user.isDeleted">
            <!-- Avatar -->
            <td class="ps-4">
              @if (getAvatarUrl(user)) {
              <img [src]="getAvatarUrl(user)" [alt]="user.fullName" class="user-avatar" />
              } @else {
              <div class="user-avatar avatar-initials">
                {{ getInitials(user.fullName) }}
              </div>
              }
            </td>

            <!-- User Info -->
            <td>
              <span class="user-info-name">
                {{ user.fullName }}
                @if (user.isDeleted) {
                <span class="deleted-badge">Deleted</span>
                }
              </span>
              <span class="user-info-email">
                {{ user.email }}
                @if (user.emailConfirmed) {
                <i class="fas fa-check-circle verified-badge" title="Email Verified"></i>
                } @else {
                <i
                  class="fas fa-exclamation-circle unverified-badge"
                  title="Email Not Verified"
                ></i>
                }
              </span>
            </td>

            <!-- Phone -->
            <td>
              @if (user.phoneNumber) {
              <span>
                +{{ user.phoneNumber }}
                @if (user.phoneNumberConfirmed) {
                <i class="fas fa-check-circle verified-badge" title="Phone Verified"></i>
                } @else {
                <i
                  class="fas fa-exclamation-circle unverified-badge"
                  title="Phone Not Verified"
                ></i>
                }
              </span>
              } @else {
              <span class="text-muted">-</span>
              }
            </td>

            <!-- Role -->
            <td>
              <span class="status-badge" [ngClass]="getRoleBadgeClass(user.role)">
                {{ user.role }}
              </span>
            </td>

            <!-- Orders -->
            <td>{{ user.ordersCount }} Order(s)</td>

            <!-- Activity -->
            <td>
              <div class="d-flex flex-column">
                <span class="fw-medium">{{ user.created | date : 'mediumDate' }}</span>
                @if (user.updated) {
                <span class="text-muted" style="font-size: 11px; white-space: nowrap">
                  <i class="fas fa-clock me-1"></i>Updated: {{ user.updated | date : 'shortDate' }}
                </span>
                } @else {
                <span class="text-muted" style="font-size: 11px; opacity: 0.5">
                  <i class="fas fa-clock me-1"></i>Joined
                </span>
                }
              </div>
            </td>

            <!-- Actions -->
            <td>
              @if (isCurrentUser(user.id)) {
              <span class="current-user-badge"><span class="active-dot"></span>Logged In</span>
              } @else {
              <button
                class="action-btn btn-edit"
                [routerLink]="'/admin/users/edit/' + user.id"
                title="Edit User"
              >
                <i class="fas fa-edit"></i>
              </button>
              @if (!user.isDeleted) {
              <button
                class="action-btn btn-delete"
                (click)="deleteUser(user.id)"
                title="Delete User"
              >
                <i class="fas fa-trash"></i>
              </button>
              } @else {
              <button
                class="action-btn btn-restore"
                (click)="restoreUser(user.id)"
                title="Restore User"
              >
                <i class="fas fa-trash-restore"></i>
              </button>
              } }
            </td>
          </tr>
          } @empty {
          <tr>
            <td colspan="7" class="text-center py-5">
              <i class="fas fa-users" style="font-size: 3rem; color: #ccc"></i>
              <p class="mt-3 text-muted">No users found.</p>
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>
  </div>

  <!-- Pagination -->
  <div class="d-flex justify-content-center mt-4">
    <!-- Hidden element to initialize pagination service -->
    <div style="display: none">
      @for (user of users() | paginate: { id: 'usersPagination', itemsPerPage: pageSize,
      currentPage: pageIndex, totalItems: totalCount() }; track user.id) {
      <div></div>
      }
    </div>

    <pagination-template
      #p="paginationApi"
      [id]="'usersPagination'"
      (pageChange)="onPageChange($event)"
    >
      <nav>
        <ul class="pagination">
          <li class="page-item" [class.disabled]="p.isFirstPage()">
            <a class="page-link" (click)="p.previous()" style="cursor: pointer">
              <i class="fas fa-chevron-left"></i>
            </a>
          </li>
          @for (page of p.pages; track page.value) {
          <li class="page-item" [class.active]="p.getCurrent() === page.value">
            <a class="page-link" (click)="p.setCurrent(page.value)" style="cursor: pointer">
              {{ page.label }}
            </a>
          </li>
          }
          <li class="page-item" [class.disabled]="p.isLastPage()">
            <a class="page-link" (click)="p.next()" style="cursor: pointer">
              <i class="fas fa-chevron-right"></i>
            </a>
          </li>
        </ul>
      </nav>
    </pagination-template>
  </div>
</div>

<!-- Confirmation Modal -->
<div
  class="modal fade"
  id="confirmModal"
  tabindex="-1"
  aria-labelledby="confirmModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title" id="confirmModalLabel">
          <i [class]="confirmModalIcon()" class="me-2"></i>
          {{ confirmModalTitle() }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-muted">
        {{ confirmModalMessage() }}
      </div>
      <div class="modal-footer border-0 pt-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button
          type="button"
          [class]="'btn ' + confirmModalButtonClass()"
          (click)="confirmAction()"
        >
          {{ confirmModalButtonText() }}
        </button>
      </div>
    </div>
  </div>
</div>
